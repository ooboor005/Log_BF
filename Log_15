-- รอให้ระบบพร้อมก่อน
repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
repeat task.wait() until Players.LocalPlayer

local HttpService = game:GetService("HttpService")
local GuiService = game:GetService("GuiService")

local running = true

task.spawn(function()
    while running do
        -- pcall ใหญ่: ครอบทั้งรอบ
        local ok, err = pcall(function()
            -- หยุดเมื่อมีการตัดการเชื่อมต่อ
            local ok1, _ = pcall(function()
                local code = GuiService:GetErrorCode().Value
                if code >= Enum.ConnectionError.DisconnectErrors.Value
                and code <  Enum.ConnectionError.PlacelaunchOtherError.Value then
                    running = false
                end
            end)
            if not ok1 then
                -- เงียบไว้ก็ได้ หรือ warn ไว้สำหรับดีบัก
            end
            if not running then return end

            -- ดึงค่า Diamonds (มี default กัน nil)
            local lp = Players.LocalPlayer
            local diamonds = lp:GetAttribute("Diamonds")
            if diamonds == nil then diamonds = 0 end

            -- เวลาเซิร์ฟเวอร์ (fallback ถ้า method ใช้ไม่ได้)
            local serverUnix
            local ok2, t = pcall(function() return workspace:GetServerTimeNow() end)
            serverUnix = ok2 and t or os.time()

            -- เขียนไฟล์
            writefile("Log_99.json", HttpService:JSONEncode({
                playerName = lp.Name,
                Diamond    = diamonds,
                time       = os.date("!%Y-%m-%dT%H:%M:%SZ", serverUnix),
            }))
        end)

        if not ok then
            warn("[writer] รอบนี้มีข้อผิดพลาด:", err)
        end

        task.wait(3)
    end
end)
