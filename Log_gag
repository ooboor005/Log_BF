-- รอจนเกมโหลดเสร็จ
repeat task.wait() until game:IsLoaded()

local HttpService = game:GetService("HttpService")
local GuiService  = game:GetService("GuiService")
local Players     = game:GetService("Players")
local RS          = game:GetService("ReplicatedStorage")
local WS          = game:GetService("Workspace")

local running = true

-- ตัวช่วยเลือกค่าตัวแรกที่ไม่ nil
local function firstNonNil(...)
    local n = select("#", ...)
    for i = 1, n do
        local v = select(i, ...)
        if v ~= nil then return v end
    end
    return nil
end

-- ปัดทศนิยม n ตำแหน่ง (รองรับค่าติดลบด้วย)
local function roundTo(x, n)
    n = n or 0
    local p = 10 ^ n
    if x >= 0 then
        return math.floor(x * p + 0.5) / p
    else
        return math.ceil(x * p - 0.5) / p
    end
end

task.spawn(function()
    -- โหลด DataService อย่างปลอดภัย
    local DataService
    do
        local ok, res = pcall(function()
            return require(RS.Modules.DataService)
        end)
        if not ok then
            warn("[writer] โหลด DataService ไม่ได้:", res)
            return
        end
        DataService = res
    end

    -- ปรับช่วงเวลาเป็น 2–5 วิ เพื่อลดการเขียนถี่เกินไป (1 วิ อาจหนักเกิน/โดน throttle)
    while running and task.wait(2) do
        local ok_round, err_round = pcall(function()
            -- 1) ดึงข้อมูล + Sheckles
            local pets = {}
            local sheckless = 0 -- ให้มีคีย์ใน JSON เสมอ

            do
                local ok, err = pcall(function()
                    local data = DataService:GetData()
                    if data then
                        -- รองรับหลายคีย์ของ Sheckles
                        sheckless =
                            firstNonNil(
                                data.Sheckles,
                                data.Sheckless,
                                data.sheckles,
                                data.sheckless,
                                (data.Currency and data.Currency.Sheckles),
                                (data.Currencies and data.Currencies.Sheckles)
                            ) or sheckless

                        -- เดินอินเวนทอรีสัตว์เลี้ยงแบบยืดหยุ่น
                        local inv = data.PetsData
                            and data.PetsData.PetInventory
                            and data.PetsData.PetInventory.Data

                        if type(inv) == "table" then
                            for _, v in pairs(inv) do
                                -- รองรับทั้ง 2 สchemา: บนสุด vs ใต้ PetData
                                local petType    = firstNonNil(v.PetType,   v.petType,   v.PetData and v.PetData.PetType)
                                local baseWeight = firstNonNil(v.BaseWeight,v.baseWeight,v.PetData and v.PetData.BaseWeight)
                                local level      = firstNonNil(v.Level,     v.level,     v.PetData and v.PetData.Level)

                                -- บางเกมเก็บชื่อไว้เป็น DisplayName/CustomName
                                local display = firstNonNil(
                                    v.DisplayName, v.displayName, v.CustomName, v.customName,
                                    v.PetData and (v.PetData.DisplayName or v.PetData.CustomName)
                                )

                                -- ถ้ายังไม่มีชื่อ ให้ใช้ petType เป็นชื่อหลัก
                                local name = firstNonNil(display, petType)

                                -- >>> แปลง weight เป็นเลขทศนิยม 1 ตำแหน่ง <<<
                                local wnum = tonumber(baseWeight) or 0
                                local w1   = roundTo(wnum, 1)  -- ตัวอย่าง: 1.14456746 -> 1.1

                                if name then
                                    table.insert(pets, {
                                        name   = tostring(name),
                                        weight = w1,
                                        age    = tonumber(level) or 0
                                    })
                                else
                                    table.insert(pets, {
                                        name   = "Unknown",
                                        weight = w1,
                                        age    = tonumber(level) or 0
                                    })
                                end
                            end
                        else
                            warn("[writer] ไม่พบตาราง PetInventory.Data ที่คาดไว้")
                        end
                    end
                end)
                if not ok then
                    warn("[writer] ดึงข้อมูลจาก DataService พัง:", err)
                end
            end

            -- 2) เช็กการเชื่อมต่อ
            do
                local ok, err = pcall(function()
                    local code = GuiService:GetErrorCode().Value
                    if code >= Enum.ConnectionError.DisconnectErrors.Value
                    and code <  Enum.ConnectionError.PlacelaunchOtherError.Value then
                        running = false
                    end
                end)
                if not ok then
                    warn("[writer] เช็ก errorCode พัง:", err)
                end
            end
            if not running then return end

            -- 3) เขียนไฟล์ JSON
            do
                local ok, err = pcall(function()
                    local serverUnix = WS:GetServerTimeNow()
                    local payload = {
                        playerName = Players.LocalPlayer and Players.LocalPlayer.Name or "UnknownPlayer",
                        time       = os.date("!%Y-%m-%dT%H:%M:%SZ", serverUnix),
                        pets       = pets,
                        sheckless  = sheckless,
                    }
                    local json = HttpService:JSONEncode(payload)
                    writefile("Log_gag.json", json)
                end)
                if not ok then
                    warn("[writer] เขียนไฟล์ล้มเหลว:", err)
                end
            end
        end)

        if not ok_round then
            warn("[writer] รอบนี้มีข้อผิดพลาด (pcall ใหญ่จับไว้แล้ว):", err_round)
        end
    end
end)
