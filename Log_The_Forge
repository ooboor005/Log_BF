-- LocalScript (ใส่ใน StarterPlayer > StarterPlayerScripts)

local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- ScreenGui
local gui = Instance.new("ScreenGui")
gui.Name = "TheForgeGui"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

-- Frame หลัก
local frame = Instance.new("Frame")
frame.Size = UDim2.fromScale(0.25, 0.12)
frame.Position = UDim2.fromScale(0.5, 0.15)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
frame.Parent = gui

-- มุมโค้ง
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 16)
corner.Parent = frame

-- ข้อความ
local title = Instance.new("TextLabel")
title.Size = UDim2.fromScale(1, 1)
title.BackgroundTransparency = 1
title.Text = "The Forge"
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.TextColor3 = Color3.fromRGB(255, 220, 120)
title.Parent = frame

-- เส้นขอบ
local stroke = Instance.new("UIStroke")
stroke.Thickness = 3
stroke.Parent = frame

-- สีเหลื่อม (Gradient สีเหลือง)
local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
	ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 160)),
	ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 200, 60)),
	ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 240, 140)),
}
gradient.Parent = stroke


-- รอให้ระบบพร้อมก่อน
repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")

local Equipments = require(ReplicatedStorage.Shared.Data.Equipments)
local Knit = require(Shared.Packages.Knit)
local PlayerController = Knit.GetController("PlayerController")
local Replica = PlayerController.Replica

local PlayerGui = lp:WaitForChild("PlayerGui")

local Pickaxes = {}
local Gold

local HttpService = game:GetService("HttpService")
local GuiService = game:GetService("GuiService")

local running = true

task.spawn(function()
    while running do
        table.clear(Pickaxes)

        -- pcall ใหญ่: ครอบทั้งรอบ
        local ok, err = pcall(function()
            -- หยุดเมื่อมีการตัดการเชื่อมต่อ
            local ok1, _ = pcall(function()
                local code = GuiService:GetErrorCode().Value
                if code >= Enum.ConnectionError.DisconnectErrors.Value
                and code <  Enum.ConnectionError.PlacelaunchOtherError.Value then
                    running = false
                end
            end)
            if not ok1 then
                -- เงียบไว้ก็ได้ หรือ warn ไว้สำหรับดีบัก
            end
            if not running then return end

            -- ส่วนที่แก้ไข Level
            local LevelText = lp.PlayerGui.Main.Screen.Hud.Level.Text
            -- ใช้ string.match(LevelText, "%d+") เพื่อดึงเฉพาะตัวเลข (0-9) ออกมาจากข้อความ
            local LevelNumberString = string.match(LevelText, "%d+") 
            local Level = tonumber(LevelNumberString) or 0

            local CurrentRace = PlayerGui.Sell.RaceUI.StatMain.Slots.SlotTemplate.CurrentRace.Text
            local CleanRace = CurrentRace:gsub("~", ""):gsub("%s+", "")
            -- ดึงค่า Gold
            Gold = math.floor(tonumber(Replica.Data.Gold) or 0)
            local Reroll_Text = PlayerGui.Sell.RaceUI.Reroll.Spins.Text
            local Reroll = Reroll_Text:gsub("Spins:", ""):gsub("%s+", "")
            
            for _, item in pairs(Replica.Data.Inventory.Equipments) do
                if typeof(item) == "table" then
                    if Equipments.Items.Pickaxe[item.Name] then table.insert(Pickaxes, item.Name) end
                end
            end

            -- เวลาเซิร์ฟเวอร์ (fallback ถ้า method ใช้ไม่ได้)
            local serverUnix
            local ok2, t = pcall(function() return workspace:GetServerTimeNow() end)
            serverUnix = ok2 and t or os.time()
    
            -- เขียนไฟล์
            writefile("Log_The_Forge.json", HttpService:JSONEncode({
                playerName = lp.Name,
                Level = Level,
                Gold    = Gold,
                item    = Pickaxes,
                CurrentRace = CleanRace,
                Reroll = Reroll,
                time   = os.date("!%Y-%m-%dT%H:%M:%SZ", serverUnix),
            }))

            table.clear(Pickaxes)
        end)

        if not ok then
            warn("[writer] รอบนี้มีข้อผิดพลาด:", err)
        end
        task.wait(3)
        
    end
end)
